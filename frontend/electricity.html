<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Electricity Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />

 <style>
  body {
    font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Yu Gothic", sans-serif;
    font-weight: bold;
    margin: 0; padding: 0;
    background: #f4f6fa;
    color: #222;
  }

  header {
    background: #1f2937;
    color: white;
    padding: 15px 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  h2 {
    margin: 0 0 15px 0;
    font-size: 26px;
    letter-spacing: 1px;
  }

  .controls {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
  }

  select, input, button {
    font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Yu Gothic", sans-serif;
    font-weight: bold;
    font-size: 18px;
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #2563eb;
    outline: none;
    transition: 0.2s;
  }

  select:hover, input:hover, button:hover {
    transform: scale(1.03);
    box-shadow: 0 0 8px rgba(37,99,235,0.3);
  }

  button {
    background: #2563eb;
    color: white;
    cursor: pointer;
  }

  /* ====== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…¨ä½“ ====== */
  .main-layout {
    display: grid;
    grid-template-columns: 280px 1fr 1.1fr; /* å·¦: KPI, ä¸­å¤®: Viewer, å³: è¡¨ï¼‹ã‚°ãƒ©ãƒ• */
    gap: 16px;
    height: calc(100vh - 180px);
    margin: 10px 20px;
  }

  /* å·¦å´ KPI */
  .left-panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .kpi {
    flex: 1;
    min-height: 140px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  }


/* ä¸­å¤® Viewer */
.viewer-panel {
  position: relative;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  display: flex;
}

#forgeViewer {
  width: 100%;
  height: 100%;
  max-height: 100%; /* âœ… gridã®é«˜ã•å†…ã«åã¾ã‚‹ */
  border-radius: 12px;
  object-fit: contain; /* âœ… Viewerå†…å®¹ãŒã¯ã¿å‡ºãªã„ã‚ˆã†èª¿æ•´ */
}


  /* å³å´ï¼ˆè¡¨ï¼‹ã‚°ãƒ©ãƒ•ï¼‰ */
  .right-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
  }

  .ranking-section {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 10px;
    overflow-y: auto;
  }

  #rankingTable {
    width: 100%;
    border-collapse: collapse;
    text-align: right;
  }

  #rankingTable th, #rankingTable td {
    padding: 8px 10px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 14px;
  }

  #rankingTable th {
    background: #f9fafb;
    position: sticky;
    top: 0;
  }

  .graph-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex: 1;
  }

  .graph-box {
    background: white;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: 50%;
  }
</style>

</head>

<body>
  <header>
    <h2>é›»åŠ›é‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <div class="controls">
      <input id="start" placeholder="é–‹å§‹æ—¥" />
      <input id="end" placeholder="çµ‚äº†æ—¥" />
    <button onclick="onUpdateClick()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>

    </div>
  </header>

  <div class="main-layout">
  <!-- å·¦ï¼šKPI -->
  <div class="left-panel">
    <div id="avgKPI" class="kpi"></div>
    <div id="maxKPI" class="kpi"></div>
    <div id="minKPI" class="kpi"></div>
  </div>

  <!-- ä¸­å¤®ï¼šViewer -->
  <div class="viewer-panel">
    <div id="forgeViewer"></div>
  </div>

  <!-- å³ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚° + ã‚°ãƒ©ãƒ•2ã¤ -->
  <div class="right-panel">
    <div class="ranking-section">
      <table id="rankingTable"></table>
    </div>
    <div class="graph-section">
      <div id="barChart" class="graph-box"></div>
      <div id="lineChart" class="graph-box"></div>
    </div>
  </div>
</div>


 <!-- ï¼ˆå‰åŠã®HTMLãƒ»CSSã¯ãã®ã¾ã¾ã§OKï¼‰ -->

<script>
console.log("âœ… electricity.html script loaded");
flatpickr("#start", { locale: "ja", dateFormat: "Y-m-d", defaultDate: "2023-07-01" });
flatpickr("#end", { locale: "ja", dateFormat: "Y-m-d", defaultDate: "2023-07-07" });

// === KPIæç”»ï¼ˆå…±é€šã‚¹ã‚±ãƒ¼ãƒ«ï¼‹è‰²åˆ†ã‘ï¼‰ ===
function getColorByUsage(value, maxValue) {
  const ratio = value / maxValue;
  if (ratio < 0.25) return "#3b82f6";
  if (ratio < 0.5) return "#10b981";
  if (ratio < 0.75) return "#facc15";
  return "#ef4444";
}

function renderKPI(domId, title, value, unit = "kWh", globalMax = 1000) {
  const dom = document.getElementById(domId);
  echarts.dispose(dom);
  const chart = echarts.init(dom);
  const color = getColorByUsage(value, globalMax);

  chart.setOption({
    title: { text: title, left: "center", top: 10, textStyle: { fontSize: 16, fontWeight: "bold" } },
    series: [{
      type: "gauge",
      radius: "90%",
      min: 0,
      max: globalMax,
      progress: { show: true, width: 14, itemStyle: { color } },
      axisLine: { lineStyle: { width: 14, color: [[1, "#e5e7eb"]] } },
      pointer: { show: true, width: 4, length: "80%", itemStyle: { color: "#000000" } },
      axisLabel: { fontSize: 12 },
      detail: { valueAnimation: true, formatter: `${value.toFixed(1)} ${unit}`, fontSize: 15, color },
      data: [{ value }]
    }]
  });
}

// === Forge Viewer åˆæœŸåŒ– ===
let viewer;
async function initViewer() {
  const options = {
    env: "AutodeskProduction",
    getAccessToken: async (onTokenReady) => {
      const res = await fetch('/api/aps/oauth/token');
      const token = await res.json();
      onTokenReady(token.access_token, token.expires_in);
    }
  };
  Autodesk.Viewing.Initializer(options, () => {
    const htmlDiv = document.getElementById("forgeViewer");
    viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);
    viewer.start();

    const documentId = "urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6YndtdDFhOWtzeXNwa3AzbHY2MWNsZGxveXUxeHQwenEtYmFzaWMtYXBwLyglRTUlQkElQTclRTUlQjglQUQlRTMlODMlQkIlRTQlQkYlQUUlRTclQjklOTUpJUU4JUI1JUE0JUU1JTlEJTgyWCVFNyVBNCVCRSVFMyU4MyU5MyVFMyU4MyVBQiVFNCVCOCU4RCVFNSU4QiU5NSVFNyU5NCVBMyVFNyVBRSVBMSVFNyU5MCU4NkJJTSVFMyU4MyVBMiVFMyU4MyU4NyVFMyU4MyVBQl8wNTE0LnJ2dA";
    Autodesk.Viewing.Document.load(documentId, (doc) => {
      const defaultModel = doc.getRoot().getDefaultGeometry();
      viewer.loadDocumentNode(doc, defaultModel).then(() => viewer.fitToView());
    }, (err) => console.error("âŒ Document load failed:", err));
  });
}



 // === ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æç”» ===
async function loadElectricity() {
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  // =============================
  // â‘  æ™‚é–“åˆ¥å¹³å‡ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
  // =============================
  const urlHourly = `http://localhost:3001/api/electricity/hourly?floor_min=1&floor_max=9&start=${start}&end=${end}`;
  console.log("Fetch hourly:", urlHourly);

  const resHourly = await fetch(urlHourly);
  const hourlyData = await resHourly.json();
  if (!hourlyData.length) {
    alert("æ™‚é–“åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // =============================
  // â‘¡ åˆè¨ˆé›»åŠ›é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆKPIãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰
  // =============================
  const urlSum = `http://localhost:3001/api/electricity?floor_min=1&floor_max=9&start=${start}&end=${end}`;
  console.log("Fetch total:", urlSum);

  const resSum = await fetch(urlSum);
  const sumData = await resSum.json();
  if (!sumData.length) {
    alert("åˆè¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // ---- é›†è¨ˆï¼ˆåˆè¨ˆï¼‰----
  const floors = [...new Set(sumData.map(d => d.floor))].sort((a, b) => a - b);
  const floorSum = floors.map(floor => {
    const row = sumData.find(d => d.floor === floor);
    return row ? Number(row.kwh_sum) : 0;
  });

  const totalSum = floorSum.reduce((a, b) => a + b, 0);
  const maxSum = Math.max(...floorSum);
  const minSum = Math.min(...floorSum);
  const maxF = floors[floorSum.indexOf(maxSum)];
  const minF = floors[floorSum.indexOf(minSum)];

// =============================
// â‘¢ å…¨ä½“å¹³å‡ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰ã‚’æ­£ç¢ºã«ç®—å‡º
// =============================

// âœ… BigQueryã®æ—¥åˆ¥ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å…¨éšåˆè¨ˆã‚’å–å¾—
const resDaily = await fetch(
  `http://localhost:3001/api/electricity/daily?start=${start}&end=${end}`
);
const dailyData = await resDaily.json();

if (!dailyData.length) {
  alert("æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
  return;
}
console.log("ğŸ“Š æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿:", dailyData);

// âœ… å„æ—¥ã®å…¨éšåˆè¨ˆã‚’ç®—å‡º
const dailyTotals = {};
dailyData.forEach(d => {
  const date = d.date?.value || d.date;
  if (!dailyTotals[date]) dailyTotals[date] = 0;
  dailyTotals[date] += d.kwh_sum;
});

// âœ… å„æ—¥åˆè¨ˆã®å¹³å‡ï¼ˆ= å…¨ä½“ã®1æ—¥å¹³å‡ï¼‰
const avgPerDayTotal =
  Object.values(dailyTotals).reduce((a, b) => a + b, 0) /
  Object.values(dailyTotals).length;

// âœ… å„éšã‚‚æ—¥å¹³å‡ã«æ›ç®—
const startDate = new Date(start);
const endDate = new Date(end);
const days = (endDate - startDate) / (1000 * 60 * 60 * 24) + 1;
const avgPerDay = totalSum / days / floors.length;
const maxAvgPerDay = Math.max(...floorSum) / days;
const minAvgPerDay = Math.min(...floorSum) / days;

// 3ãƒ¡ãƒ¼ã‚¿ãƒ¼å…±é€šã‚¹ã‚±ãƒ¼ãƒ«
const globalMax = Math.ceil(Math.max(avgPerDay, maxAvgPerDay) * 1.2 / 50) * 50;

// === KPIæç”»ï¼ˆä¿®æ­£ç‰ˆï¼‰ ===
renderKPI("avgKPI", "å…¨ä½“å¹³å‡ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰", avgPerDay, "kWh/æ—¥", globalMax);
renderKPI("maxKPI", `æœ€å¤§åˆ©ç”¨éš (${floors[floorSum.indexOf(Math.max(...floorSum))]}F)`, maxAvgPerDay, "kWh/æ—¥", globalMax);
renderKPI("minKPI", `æœ€å°åˆ©ç”¨éš (${floors[floorSum.indexOf(Math.min(...floorSum))]}F)`, minAvgPerDay, "kWh/æ—¥", globalMax);


  // === ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ï¼ˆåˆè¨ˆãƒ™ãƒ¼ã‚¹ã®ã¾ã¾ï¼‰ ===
  const rows = floors
    .map(
      (f, i) =>
        `<tr><td>${i + 1}</td><td>${f}F</td><td>${floorSum[i].toFixed(1)} kWh</td></tr>`
    )
    .join("");
  document.getElementById("rankingTable").innerHTML = `
    <thead><tr><th>#</th><th>éš</th><th>åˆè¨ˆé›»åŠ›é‡</th></tr></thead>
    <tbody>${rows}</tbody>`;

// =============================
// â‘£ ã‚°ãƒ©ãƒ•æç”»
// =============================

// === å·¦ä¸‹ï¼šæ™‚é–“åˆ¥å¹³å‡é›»åŠ›é‡ï¼ˆéšåˆ¥ï¼‰ ===
const line1 = echarts.init(document.getElementById("barChart"));

// âœ… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šhours ã‚’å…ˆã«å®šç¾©
const hours = [...new Set(hourlyData.map(d => d.hour))].sort((a, b) => a - b);

const line1Series = floors.map(floor => ({
  name: `${floor}F`,
  type: "line",
  showSymbol: false,
  lineStyle: { width: 2 },
  data: hours.map(h => {
    const match = hourlyData.find(d => d.floor === floor && d.hour === h);
    return match ? match.kwh_avg : 0;
  }),
}));

line1.setOption({
  title: { text: "æ™‚é–“åˆ¥å¹³å‡é›»åŠ›é‡ï¼ˆéšåˆ¥ï¼‰", left: "center" },
  tooltip: { trigger: "axis" },
  legend: { top: 30, type: "scroll" },
  grid: { top: 80, left: 60, right: 20, bottom: 50 },
  xAxis: {
    type: "category",
    data: hours.map(h => `${h}:00`),
    axisLabel: { fontSize: 12 },
  },
  yAxis: {
    type: "value",
    name: "kWh",
    axisLabel: { fontSize: 12 },
  },
  series: line1Series,
});


// === å³ä¸‹ï¼šæ—¥åˆ¥é›»åŠ›é‡æ¨ç§»ï¼ˆéšåˆ¥ï¼‰ ===
const line2 = echarts.init(document.getElementById("lineChart"));

const resDaily2 = await fetch(
  `http://localhost:3001/api/electricity/daily?floor_min=1&floor_max=9&start=${start}&end=${end}`
);
const dailyData2 = await resDaily2.json();

if (!dailyData2.length) {
  alert("æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
  return;
}

// ğŸ”¹ æ—¥ä»˜ã‚’æ•´å½¢
dailyData2.forEach(d => {
  d.date = d.date?.value || d.date;
});

// ğŸ”¹ éšåˆ¥ Ã— æ—¥åˆ¥ã«é›†è¨ˆ
const floorDaily = {};
dailyData2.forEach(d => {
  if (!floorDaily[d.floor]) floorDaily[d.floor] = {};
  if (!floorDaily[d.floor][d.date]) floorDaily[d.floor][d.date] = 0;
  floorDaily[d.floor][d.date] += d.kwh_sum;
});

// ğŸ”¹ å…¨æ—¥ä»˜ãƒªã‚¹ãƒˆ
const dateList = [...new Set(dailyData2.map(d => d.date))].sort();

// ğŸ”¹ æŠ˜ã‚Œç·šã‚·ãƒªãƒ¼ã‚ºç”Ÿæˆ
const lineSeries2 = Object.keys(floorDaily).map(floor => ({
  name: `${floor}F`,
  type: "line",
  showSymbol: true,
  lineStyle: { width: 2 },
  data: dateList.map(date => floorDaily[floor][date] || 0),
}));

// ğŸ”¹ æç”»
line2.setOption({
  title: { text: "æ—¥åˆ¥é›»åŠ›é‡æ¨ç§»ï¼ˆéšåˆ¥ï¼‰", left: "center" },
  tooltip: { trigger: "axis" },
  legend: { top: 30, type: "scroll" },
  grid: { top: 80, left: 60, right: 20, bottom: 50 },
  xAxis: {
    type: "category",
    data: dateList,
    axisLabel: { rotate: 45, fontSize: 12 },
  },
  yAxis: {
    type: "value",
    name: "kWh",
    axisLabel: { fontSize: 12 },
  },
  series: lineSeries2,
});

}




// âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šViewerã ã‘åˆæœŸåŒ–ï¼ˆè‰²å¡—ã‚Šã¯ã¾ã ï¼‰
window.onload = async () => {
  console.log("ğŸ”¥ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº† â†’ Forge VieweråˆæœŸåŒ–");
  await initViewer(); // Viewerã ã‘èµ·å‹•
};

// âœ… ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ˜ç¤ºçš„ã«ãƒˆãƒªã‚¬ãƒ¼ï¼‰
async function onUpdateClick() {
  console.log("ğŸ” ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³æŠ¼ä¸‹ â†’ é›»åŠ›é‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");
  await loadElectricity(); // â† ã“ã“ã§å…¨ã¦ã®ã‚°ãƒ©ãƒ•ãƒ»KPIæç”»
  console.log("ğŸ¨ Forgeãƒ¢ãƒ‡ãƒ«è‰²åˆ†ã‘å‡¦ç†ã‚’é–‹å§‹");
  await colorWallsByElectricityFromServer(); // â† ä¸‹ã§å®šç¾©ã™ã‚‹
}
  // â¬‡â¬‡â¬‡ ã“ã®ä¸‹ã«ã‚³ãƒ”ãƒš â¬‡â¬‡â¬‡
  // ======================================================
  // ğŸ”¹ Forge Viewer é›»åŠ›é‡è‰²åˆ†ã‘æ©Ÿèƒ½è¿½åŠ 
  // ======================================================

  // å„éšã®æ—¥å¹³å‡é›»åŠ›é‡ã‚’ã‚‚ã¨ã«Forgeãƒ¢ãƒ‡ãƒ«ã‚’è‰²åˆ†ã‘
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã‚’éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã§è‰²åˆ†ã‘
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã‚’éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã§è‰²åˆ†ã‘ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆï¼‰
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã‚’éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã§è‰²åˆ†ã‘ï¼ˆå®Œå…¨æ¢ç´¢ç‰ˆï¼‰
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã®å…¨ãƒãƒ¼ãƒ‰ã‚’èµ°æŸ»ã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç¢ºèªç”¨ãƒ­ã‚°å‡ºåŠ›
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã‚’éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã§è‰²åˆ†ã‘ï¼ˆå®Œå…¨æ¢ç´¢ï¼‹åŸºæº–ãƒ¬ãƒ™ãƒ«:B1FLå¯¾å¿œï¼‰
// âœ… Forgeãƒ¢ãƒ‡ãƒ«ã‚’éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã§è‰²åˆ†ã‘
// ï¼ˆKPIãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨åŒè‰² / å£ã®ã¿è¡¨ç¤º / å£ã¯é€éè¡¨ç¤ºï¼‰
async function colorWallsByElectricityFromServer() {
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  console.log("ğŸ“¡ Forgeç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹:", start, "â†’", end);

  // --- æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿å–å¾— ---
  const res = await fetch(
    `http://localhost:3001/api/electricity/daily?floor_min=1&floor_max=9&start=${start}&end=${end}`
  );
  const dailyData = await res.json();
  if (!dailyData.length) {
    console.warn("âš  æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // --- âœ… éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡ã‚’ç®—å‡º ---
  const floorDailyAvg = {};
  dailyData.forEach((d) => {
    const date = d.date?.value || d.date;
    if (!floorDailyAvg[d.floor]) floorDailyAvg[d.floor] = [];
    floorDailyAvg[d.floor].push(d.kwh_sum);
  });
  Object.keys(floorDailyAvg).forEach((f) => {
    floorDailyAvg[f] =
      floorDailyAvg[f].reduce((a, b) => a + b, 0) / floorDailyAvg[f].length;
  });

  console.log("ğŸ¨ éšåˆ¥æ—¥å¹³å‡é›»åŠ›é‡:", floorDailyAvg);

  const model = viewer.model;
  if (!model) {
    console.warn("âš  Forgeãƒ¢ãƒ‡ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  const it = model.getData().instanceTree;
  const colorMap = makeColorMap(floorDailyAvg);

  // âœ… å…¨ãƒãƒ¼ãƒ‰æ¢ç´¢ï¼ˆå®Œå…¨å†å¸°ï¼‰
  const allDbIds = [];
  function enumAllNodes(nodeId) {
    allDbIds.push(nodeId);
    it.enumNodeChildren(nodeId, (childId) => enumAllNodes(childId));
  }
  enumAllNodes(it.getRootId());
  console.log(`ğŸ§± ãƒ¢ãƒ‡ãƒ«å…¨ä½“ã®dbIdæ•°: ${allDbIds.length}`);

  const wallDbIds = []; // å£ã ã‘ä¿å­˜

  // --- å…¨dbIdèµ°æŸ» ---
  for (const dbId of allDbIds) {
    await new Promise((resolve) => {
      viewer.getProperties(dbId, (props) => {
        if (!props || !props.properties) return resolve();

        const categoryProp = props.properties.find(
          (p) => p.displayName === "ã‚«ãƒ†ã‚´ãƒª" || p.displayName === "Category"
        );
        if (
          !categoryProp ||
          (!categoryProp.displayValue.includes("å£") &&
           !categoryProp.displayValue.includes("Wall"))
        ) return resolve();

        const baseLevelProp = props.properties.find(
          (p) =>
            p.displayName.includes("åŸºæº–ãƒ¬ãƒ™ãƒ«") ||
            p.displayName.includes("Base Level")
        );
        const baseLevel = baseLevelProp?.displayValue;
        if (!baseLevel) return resolve();

        // âœ… "B1FL" â†’ -1, "1FL" â†’ 1, "2FL" â†’ 2 ã®ã‚ˆã†ã«å¤‰æ›ï¼ˆP1FLã¯é™¤å¤–ï¼‰
let floor = null;

// "B"ã‹ã‚‰å§‹ã¾ã‚‹åœ°ä¸‹éš ("B1FL" â†’ -1)
if (/^B\d+FL$/i.test(baseLevel)) {
  const num = parseInt(baseLevel.match(/^B(\d+)FL$/i)[1]);
  floor = -num;

// æ•°å­—ã‹ã‚‰å§‹ã¾ã‚‹é€šå¸¸éš ("1FL" â†’ 1, "2FL" â†’ 2)
} else if (/^\d+FL$/i.test(baseLevel)) {
  floor = parseInt(baseLevel.match(/^(\d+)FL$/i)[1]);

// GLï¼ˆGround Levelï¼‰ã¯1Fæ‰±ã„
} else if (baseLevel.toUpperCase().includes("GL")) {
  floor = 1;

// ãã‚Œä»¥å¤–ï¼ˆP1FL, RF, M1FL ãªã©ï¼‰ã¯å¯¾è±¡å¤–
} else {
  resolve();
  return;
}


        if (!floor || !floorDailyAvg[floor]) return resolve();

        wallDbIds.push({ dbId, floor });
        resolve();
      });
    });
  }

  console.log(`ğŸ¯ å£ã‚«ãƒ†ã‚´ãƒªå¯¾è±¡æ•°: ${wallDbIds.length}`);

  // âœ… å£ä»¥å¤–ã‚’éè¡¨ç¤º
  const allIds = allDbIds;
  const visibleIds = wallDbIds.map(w => w.dbId);
  viewer.isolate(visibleIds);
  console.log("ğŸ‘ï¸ å£ä»¥å¤–ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚");

  // âœ… å£ã‚’é€éè‰²ã§ç€è‰²
  const transparency = 0.5; // 0=ä¸é€æ˜, 1=å®Œå…¨é€æ˜
  for (const { dbId, floor } of wallDbIds) {
    const c = colorMap[floor];
    const color = new THREE.Vector4(
      c.r / 255,
      c.g / 255,
      c.b / 255,
      1 - transparency
    );
    viewer.setThemingColor(dbId, color);
  }

  console.log(`âœ… è‰²ä»˜ã‘å®Œäº†ï¼ˆé€éç‡: ${transparency}ï¼‰`);
  viewer.impl.sceneUpdated(true);
}







  // -----------------------------
  // åŸºæº–ãƒ¬ãƒ™ãƒ« â†’ éšç•ªå·å¤‰æ›
  // -----------------------------
  function levelToFloorNumber(baseLevel) {
    if (!baseLevel) return null;
    if (baseLevel.includes("GL") || baseLevel.includes("1F")) return 1;
    const match = baseLevel.match(/(\d+)F/);
    return match ? parseInt(match[1]) : null;
  }

  // -----------------------------
  // é›»åŠ›é‡ â†’ ã‚«ãƒ©ãƒ¼ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›
  // -----------------------------
  function makeColorMap(floorKwh) {
    const values = Object.values(floorKwh);
    const min = Math.min(...values);
    const max = Math.max(...values);
    const scale = (val) => (val - min) / (max - min);

    const colors = {};
    Object.entries(floorKwh).forEach(([floor, val]) => {
      const t = scale(val);
      const r = Math.round(255 * t);
      const g = Math.round(255 * (1 - Math.abs(t - 0.5) * 2));
      const b = Math.round(255 * (1 - t));
      colors[floor] = { r, g, b };
    });
    return colors;
  }

  // -----------------------------
  // loadElectricity() ã®æœ€å¾Œã«è¿½è¨˜
  // -----------------------------
  async function applyColorFromDailyData(dailyData2) {
    // å„éšã®æ—¥å¹³å‡é›»åŠ›é‡ã‚’ç®—å‡º
    const floorDailyAvg = {};
    dailyData2.forEach((d) => {
      if (!floorDailyAvg[d.floor]) floorDailyAvg[d.floor] = [];
      floorDailyAvg[d.floor].push(d.kwh_sum);
    });
    Object.keys(floorDailyAvg).forEach((floor) => {
      const arr = floorDailyAvg[floor];
      floorDailyAvg[floor] = arr.reduce((a, b) => a + b, 0) / arr.length;
    });

    // Forgeã«é©ç”¨
    await colorWallsByElectricity(floorDailyAvg);
      // -----------------------------
  // âœ… loadElectricity()ã®æœ«å°¾ã«ã“ã®å‘¼ã³å‡ºã—ã‚’è¿½åŠ 
  // -----------------------------
  await applyColorFromDailyData(dailyData2);
  }


</script>

</body>
</html>
