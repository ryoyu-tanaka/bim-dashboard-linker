<!DOCTYPE html> 
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Seat Usage Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />

  <style>
    body {
      font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Yu Gothic", sans-serif;
      font-weight: bold;
      margin: 0; padding: 0;
      background: #f4f6fa;
      color: #222;
    }

    header {
      background: #1f2937;
      color: white;
      padding: 15px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    h2 {
      margin: 0 0 15px 0;
      font-size: 26px;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    select, input, button {
      font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Yu Gothic", sans-serif;
      font-weight: bold;
      font-size: 18px;
      padding: 10px 20px;
      border-radius: 8px;
      border: 2px solid #2563eb;
      outline: none;
      transition: 0.2s;
    }

    select:hover, input:hover, button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 8px rgba(37,99,235,0.3);
    }

    button {
      background: #2563eb;
      color: white;
      cursor: pointer;
    }

/* ====== ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆKPIãƒ»Viewerãƒ»Rankingãƒ»Graphsï¼‰ ====== */
.main-layout {
  display: grid;
  grid-template-rows: 1fr 0.5fr; /* ä¸Š: KPI+Viewer+Ranking / ä¸‹: ã‚°ãƒ©ãƒ• */
  gap: 16px;
  height: calc(150vh - 10px);
  margin: 10px 20px;
}

/* === ä¸Šæ®µï¼ˆKPIï¼‹Viewerï¼‹Rankingï¼‰ === */
.top-section {
  display: grid;
  grid-template-columns: minmax(200px, 300px) 1fr 0.9fr; /* âœ… KPIå›ºå®š, Viewerå¯å¤‰, Rankingå³è©°ã‚ */
  gap: 16px;
  align-items: stretch;
}

/* === KPIåˆ— === */
.left-panel {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 12px;
  max-width: 300px;
  min-width: 240px;
  height: 100%; /* âœ… ç”»é¢ã«åˆã‚ã›ã¦ç¸¦æ–¹å‘èª¿æ•´ */
  box-sizing: border-box;
}

/* KPIã‚«ãƒ¼ãƒ‰ */
.kpi {
  flex: 1;
  min-height: 140px;          /* âœ… æœ€å°é«˜ã•ã‚’ä¿è¨¼ï¼ˆå°ç”»é¢å¯¾ç­–ï¼‰ */
  aspect-ratio: 1 / 1;        /* âœ… æ­£æ–¹å½¢æ¯”ã‚’ç¶­æŒ */
  border-radius: 12px;
  background: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 10px;
  transition: 0.2s;
}
.kpi:hover {
  transform: translateY(-3px);
}

/* KPIé–“ã®éš™é–“ãŒå‡ç­‰ã«ãªã‚‹ã‚ˆã†ã« */
.kpi-container {
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  height: 100%;
  gap: 12px;
}


/* === ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ï¼ˆä¸­å¤®å¯å¤‰ï¼‰ === */
.viewer-panel {
  position: relative;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  display: flex;
}
#forgeViewer {
  width: 100%;
  height: 100%;
  border-radius: 12px;
}

/* === ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ«ï¼ˆå³è©°ã‚ãƒ»ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºï¼‰ === */
/* === ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ« === */
.right-panel {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  padding: 8px 10px 8px 0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  align-items: flex-end;
  box-sizing: border-box;
  pointer-events: auto; /* è‡ªåˆ†ã®å†…éƒ¨ã ã‘ã§ã‚¯ãƒªãƒƒã‚¯ */
  z-index: 10;
}

/* === ãƒ†ãƒ¼ãƒ–ãƒ« === */
#rankingTable {
  width: 100%;
  border-collapse: collapse;
  text-align: right;
  table-layout: fixed; /* âœ… åˆ—å¹…å›ºå®šåŒ–ã§æ”¹è¡Œé˜²æ­¢ */
}

#rankingTable h3 {
  text-align: right;
  margin: 0 6px 10px 0;
  font-size: 17px;
  font-weight: bold;
}

#rankingTable th,
#rankingTable td {
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
  white-space: nowrap; /* âœ… æ”¹è¡Œé˜²æ­¢ */
}

#rankingTable th {
  background: #f9fafb;
  position: sticky;
  top: 0;
  z-index: 2;
}

#rankingTable tr:hover {
  background: #f3f4f6;
}

/* === æ£’ã‚°ãƒ©ãƒ•ç”¨ã‚»ãƒ« === */
#rankingTable td.bar {
  width: 100%;
  position: relative;
  padding: 0 10px;
}

.bar-bg {
  position: relative;
  height: 10px;
  background: #f1f5f9;
  border-radius: 4px;
  overflow: hidden;
  margin: 6px 0;
}

.bar-fill {
  position: absolute;
  height: 100%;
  left: 0;
  top: 0;
  border-radius: 4px;
  transition: width 0.6s ease;
}


/* === ä¸‹æ®µï¼šã‚°ãƒ©ãƒ• === */
.bottom-graphs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  width: 100%;
  align-items: stretch;
}
.bottom-graphs > div {
  background: white;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* === æ£’ã‚°ãƒ©ãƒ•ãŒVieweræ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã« === */
.bar-bg,
.bar-fill {
  pointer-events: none !important; /* âœ… Viewerã¸ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã™ */
}





  </style>
</head>

<body>
  <header>
    <h2>åº§å¸­ç¨¼åƒç‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <div class="controls">
      <select id="floor">
        <option value="7">èµ¤å‚_7éš</option>
        <option value="8">èµ¤å‚_8éš</option>
        <option value="9">èµ¤å‚_9éš</option>
      </select>
      <input id="start" placeholder="é–‹å§‹æ—¥" />
      <input id="end" placeholder="çµ‚äº†æ—¥" />
      <button onclick="loadDataAndColorize()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
    </div>
  </header>

  <!-- ğŸŒˆ ãƒ¡ã‚¤ãƒ³3ã‚«ãƒ©ãƒ æ§‹æˆ -->
  <div class="main-layout">
    <!-- ä¸Šæ®µï¼šKPIï¼‹Viewerï¼‹Ranking -->
    <div class="top-section">
      <div class="left-panel">
        <div id="avgPie" class="kpi"></div>
        <div id="topPie" class="kpi"></div>
        <div id="lowPie" class="kpi"></div>
      </div>
  
      <div class="viewer-panel">
        <div id="forgeViewer"></div>
      </div>
  
      <div class="right-panel">
        <div id= "rankingTable"></div>
          <h3>åº§å¸­åˆ¥ç¨¼åƒç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      </div>
    </div>
  
    <!-- ä¸‹æ®µï¼šã‚°ãƒ©ãƒ•ï¼ˆå·¦å³2åˆ†å‰²ã€å…¨å¹…ï¼‰ -->
    <div class="bottom-graphs">
      <div id="lineChart"></div>
      <div id="seatLineChart"></div>
    </div>
  </div>
  

</body>

  
  <script>
    flatpickr("#start", {
      locale: "ja", dateFormat: "Y-m-d", defaultDate: "2023-04-17", showMonths: 3
    });
    flatpickr("#end", {
      locale: "ja", dateFormat: "Y-m-d", defaultDate: "2023-04-21", showMonths: 3
    });

    // === ã‚«ãƒ©ãƒ¼åˆ¤å®šé–¢æ•° ===
    function getColor(rate) {
      if (rate < 30) return "#3b82f6";     // é’
      if (rate < 60) return "#10b981";     // ç·‘
      if (rate < 80) return "#facc15";     // é»„
      return "#ef4444";                    // èµ¤
    }

    // === ãƒ‰ãƒ¼ãƒŠãƒ„æç”»é–¢æ•°ï¼ˆåº§å¸­ç•ªå·ï¼‹ç¨¼åƒç‡å¯¾å¿œï¼‰ ===
    function renderDonutChart(domId, title, value, seatId = null) {
  const dom = document.getElementById(domId);
  if (!dom) return;
  echarts.dispose(dom);
  const chart = echarts.init(dom);

  const color = getColor(value);
  const mainText = seatId ? `No.${seatId}` : "";
  const subText = `${value}%`;

  chart.setOption({
    title: {
      text: title,
      left: "center",
      top: 10,
      textStyle: { fontSize: 16, fontWeight: "bold" }
    },
    series: [
      {
        type: "pie",
        radius: ["65%", "83%"],
        center: ["50%", "55%"],
        data: [
          { value, name: "ç¨¼åƒ" },
          { value: 100 - value, name: "éç¨¼åƒ" }
        ],
        color: [color, "#e5e7eb"],
        label: { show: false },
        silent: true
      }
    ],
    graphic: [
      {
        type: "text",
        left: "center",
        top: "45%",
        style: {
          text: mainText,
          fontSize: 18,
          fontWeight: "bold",
          fill: "#374151",
          textAlign: "center"
        }
      },
      {
        type: "text",
        left: "center",
        top: "55%",
        style: {
          text: subText,
          fontSize: 28,
          fontWeight: "bold",
          fill: color,
          textAlign: "center"
        }
      }
    ]
  });

  // âœ… ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆä½•åº¦å‘¼ã°ã‚Œã¦ã‚‚å®‰å®šï¼‰
  window.addEventListener("resize", () => {
    chart.resize();
  });
  setTimeout(() => chart.resize(), 300); // åˆå›æç”»è£œæ­£
}

    // === ãƒ©ãƒ³ã‚­ãƒ³ã‚°HTMLç”Ÿæˆ ===
    function renderRankingTable(seatAvg) {
      const sorted = [...seatAvg].sort((a, b) => b.rate - a.rate);

      const rows = sorted.map((s, i) => {
        const rate = parseFloat(s.rate);
        const color = getColor(rate);

        // æ¨ªæ£’ã®å¹…ã‚’å‰²åˆã§è¨­å®š
        const bar = `
          <div class="bar-bg">
            <div class="bar-fill" style="background:${color}; width:${rate}%;"></div>
          </div>
        `;

        return `
          <tr data-seat="${s.id}">
            <td class="rank" style="width:40px;">${i + 1}</td>
            <td class="seat" style="width:70px;">No.${s.id}</td>
            <td class="bar">${bar}</td>
            <td class="rate" style="width:60px; color:${color}">${rate.toFixed(1)}%</td>
          </tr>`;
      }).join("");

      const html = `
        <h3>åº§å¸­åˆ¥ç¨¼åƒç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <table>
          <thead>
            <tr>
              <th>é †ä½</th><th>åº§å¸­</th><th>ç¨¼åƒç‡</th><th>%</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      document.getElementById("rankingTable").innerHTML = html;
    }


    async function loadData() {
      const floor = document.getElementById("floor").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const shop_name = `èµ¤å‚_${floor}éš`;
      const url = `http://13.231.123.15:3000/api/seat-usage?shop_name=${encodeURIComponent(shop_name)}&start=${start}&end=${end}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.length) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

      // --- æ—¥åˆ¥å¹³å‡ ---
      const grouped = {};
      data.forEach(r => {
        const date = r.usedate.value || r.usedate;
        if (!grouped[date]) grouped[date] = { total: 0, used: 0 };
        grouped[date].total++;
        grouped[date].used += r.use_flg;
      });
      const dates = Object.keys(grouped).sort();
      const dailyRates = dates.map(d => (grouped[d].used / grouped[d].total * 100).toFixed(1));

      // --- åº§å¸­åˆ¥é›†è¨ˆ ---
      const seatDaily = {};
      data.forEach(r => {
        const id = r.seat_id;
        const date = r.usedate.value || r.usedate;
        if (!seatDaily[id]) seatDaily[id] = {};
        if (!seatDaily[id][date]) seatDaily[id][date] = { used: 0, total: 0 };
        seatDaily[id][date].used += r.use_flg;
        seatDaily[id][date].total++;
      });

      const seatSeries = Object.keys(seatDaily).map(id => ({
        name: `#${id}`,
        type: "line",
        smooth: false,
        showSymbol: false,
        data: dates.map(d =>
          seatDaily[id][d] ? (seatDaily[id][d].used / seatDaily[id][d].total * 100).toFixed(1) : 0
        )
      }));

      const seatAvg = Object.entries(seatDaily).map(([id, obj]) => {
        let sumUsed = 0, sumTotal = 0;
        Object.values(obj).forEach(v => { sumUsed += v.used; sumTotal += v.total; });
        return { id, rate: (sumUsed / sumTotal * 100).toFixed(1) };
      });

      const avg = (dailyRates.reduce((a,b)=>a+parseFloat(b),0)/dailyRates.length).toFixed(1);
      const topSeat = seatAvg.reduce((a,b)=> a.rate > b.rate ? a : b);
      const lowSeat = seatAvg.reduce((a,b)=> a.rate < b.rate ? a : b);

      // --- KPI 3ã¤ã‚’ãƒ‰ãƒ¼ãƒŠãƒ„ã§æç”» ---
      document.getElementById("avgPie").innerHTML = "";
      document.getElementById("topPie").innerHTML = "";
      document.getElementById("lowPie").innerHTML = "";
      renderDonutChart("avgPie", "å¹³å‡ç¨¼åƒç‡", parseFloat(avg));
      renderDonutChart("topPie", "æœ€ã‚‚ç¨¼åƒç‡ãŒé«˜ã„åº§å¸­", parseFloat(topSeat.rate), topSeat.id);
      renderDonutChart("lowPie", "æœ€ã‚‚ç¨¼åƒç‡ãŒä½ã„åº§å¸­", parseFloat(lowSeat.rate), lowSeat.id);

      // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ ---
      renderRankingTable(seatAvg);

      // --- æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’Forgeç”¨ã«ä¿å­˜ ---
      window.latestSeatAvg = seatAvg;

      // --- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• ---
      const lineChart = echarts.init(document.getElementById("lineChart"));
      lineChart.setOption({
        title: { text: `${shop_name} æ—¥åˆ¥å¹³å‡ç¨¼åƒç‡`, left: "center" },
        tooltip: { trigger: "axis", valueFormatter: (v) => `${v}%` },
        xAxis: {
          type: "category",
          data: dates.map(d => new Date(d).toLocaleDateString("ja-JP", { month: "2-digit", day: "2-digit" })),
          axisLabel: { rotate: 0, fontSize: 12 }
        },
        yAxis: {
          type: "value", max: 100,
          axisLabel: { formatter: "{value}%", fontSize: 12 }
        },
        series: [{
          data: dailyRates,
          type: "line",
          smooth: false,
          step: false,
          symbol: "circle",
          symbolSize: 6,
          lineStyle: { width: 2, color: "#2563eb" },
          areaStyle: { color: "rgba(37,99,235,0.15)" }
        }]
      });

      const seatLineChart = echarts.init(document.getElementById("seatLineChart"));
      seatLineChart.setOption({
        title: { text: "åº§å¸­åˆ¥ç¨¼åƒç‡æ¨ç§»", left: "center" },
        tooltip: { trigger: "axis", valueFormatter: (v) => `${v}%` },
        legend: { type: "scroll", bottom: 0 },
        xAxis: {
          type: "category",
          data: dates.map(d => new Date(d).toLocaleDateString("ja-JP", { month: "2-digit", day: "2-digit" })),
          axisLabel: { rotate: 0, fontSize: 12 }
        },
        yAxis: {
          type: "value", max: 100,
          axisLabel: { formatter: "{value}%", fontSize: 12 }
        },
        series: seatSeries.map(s => ({
          ...s,
          smooth: false,
          symbol: "none",
          lineStyle: { width: 1.5 },
        }))
      });

      // --- å³ä¸‹ ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ ---
      renderRankingTable(seatAvg);
    }
     // === Forge Viewer === 
let viewer;
let geometryReady = false;

async function initViewer() {
  const options = {
    env: 'AutodeskProduction',
    getAccessToken: async (onTokenReady) => {
      const res = await fetch('/api/aps/oauth/token');
      const token = await res.json();
      onTokenReady(token.access_token, token.expires_in);
    }
  };

  Autodesk.Viewing.Initializer(options, () => {
    const htmlDiv = document.getElementById('forgeViewer');
    viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);
    viewer.start();

    const documentId =
      'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6YndtdDFhOWtzeXNwa3AzbHY2MWNsZGxveXUxeHQwenEtYmFzaWMtYXBwLyglRTUlQkElQTclRTUlQjglQUQlRTMlODMlQkIlRTQlQkYlQUUlRTclQjklOTUpJUU4JUI1JUE0JUU1JTlEJTgyWCVFNyVBNCVCRSVFMyU4MyU5MyVFMyU4MyVBQiVFNCVCOCU4RCVFNSU4QiU5NSVFNyU5NCVBMyVFNyVBRSVBMSVFNyU5MCU4NkJJTSVFMyU4MyVBMiVFMyU4MyU4NyVFMyU4MyVBQl8wNTE0LnJ2dA';

    Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
  });
}

function onDocumentLoadSuccess(doc) {
  const defaultModel = doc.getRoot().getDefaultGeometry();
  viewer.loadDocumentNode(doc, defaultModel).then(() => {
    console.log("Forgeãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† âœ…");
    viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, async () => {
      geometryReady = true;
      console.log("ğŸ§± GEOMETRY_LOADED_EVENT â†’ åº§å¸­æ¢ç´¢é–‹å§‹");
      await new Promise(r => setTimeout(r, 800));
      const floorLabel = `${document.getElementById("floor").value}F`;
      identifyGeneralModelDbIds(floorLabel);
    });
  });
}

function onDocumentLoadFailure(err) {
  console.error('Document load failed:', err);
}

async function identifyGeneralModelDbIds(targetFloor = "7F") {
  const model = viewer.model;
  if (!model) return console.warn("âš ï¸ ãƒ¢ãƒ‡ãƒ«æœªãƒ­ãƒ¼ãƒ‰");
  const instanceTree = model.getData()?.instanceTree;
  if (!instanceTree) return console.warn("âš ï¸ instanceTreeæœªå–å¾—");

  // æœ«ç«¯ãƒãƒ¼ãƒ‰åé›†
  const leafIds = [];
  instanceTree.enumNodeChildren(instanceTree.getRootId(), (id) => {
    if (instanceTree.getChildCount(id) === 0) leafIds.push(id);
  }, true);

  const seatIdToDbId = {};
  model.getBulkProperties(leafIds, ['ã‚¿ã‚¤ãƒ—å', 'éšæ•°', 'éš', 'Level', 'Level Name'], results => {
    results.forEach(r => {
      const typeProp = r.properties.find(p => p.displayName === 'ã‚¿ã‚¤ãƒ—å' && typeof p.displayValue === 'string');
      const floorProp = r.properties.find(p => ['éšæ•°', 'éš', 'Level', 'Level Name'].includes(p.displayName));
      if (!typeProp || !floorProp) return;

      const typeName = typeProp.displayValue;
      const floorName = String(floorProp.displayValue || '');

      if (!/ã‚ªãƒ•ã‚£ã‚¹ãƒã‚§ã‚¢/i.test(typeName)) return;
      if (!floorName.includes(targetFloor)) return;

      const m = typeName.match(/(\d+)$/);
      if (!m) return;

      const seatId = parseInt(m[1], 10);
      seatIdToDbId[seatId] = r.dbId;
    });

    console.log(`âœ… åº§å¸­ãƒãƒƒãƒ”ãƒ³ã‚°å®Œäº†: ${Object.keys(seatIdToDbId).length}ä»¶ (target=${targetFloor})`);
    window.seatIdToDbId = seatIdToDbId;
  });
}

function highlightSeat(seatId) {
  if (!window.seatIdToDbId) return console.warn("âš ï¸ seatIdToDbId æœªå®šç¾©");
  const dbid = window.seatIdToDbId[seatId];
  if (!dbid) return console.warn(`âš ï¸ seat_id:${seatId} ã«å¯¾å¿œã™ã‚‹ dbId ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);

  viewer.clearSelection();
  viewer.isolate([dbid]);
  viewer.fitToView([dbid], viewer.model, false);
  viewer.select([dbid]);
  console.log(`ğŸ’¡ Seat ${seatId} â†’ dbId ${dbid} ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ`);
}

// ===================================================
// ğŸ¨ ç¨¼åƒç‡â†’è‰²å¤‰æ›é–¢æ•°
// === ã‚«ãƒ©ãƒ¼åˆ¤å®šé–¢æ•° ===
function getColor(rate) {
  if (rate < 30) return "#3b82f6";     // é’
  if (rate < 60) return "#10b981";     // ç·‘
  if (rate < 80) return "#facc15";     // é»„
  return "#ef4444";                    // èµ¤
}

// === HEXã‚«ãƒ©ãƒ¼ â†’ THREE.Vector4å¤‰æ› ===
function hexToVector4(hex) {
  const r = parseInt(hex.slice(1, 3), 16) / 255;
  const g = parseInt(hex.slice(3, 5), 16) / 255;
  const b = parseInt(hex.slice(5, 7), 16) / 255;
  return new THREE.Vector4(r, g, b, 1);
}


// === ç¨¼åƒç‡ã«åŸºã¥ã„ã¦Forgeã«è‰²é©ç”¨ ===
function applySeatColors(seatAvg) {
  if (!viewer || !window.seatIdToDbId) {
    console.warn("âš ï¸ viewerã¾ãŸã¯seatIdToDbIdãŒæœªå®šç¾©");
    return;
  }

  console.log("ğŸ¨ applySeatColors å®Ÿè¡Œä¸­: åº§å¸­æ•° =", seatAvg.length);
  viewer.clearThemingColors();

  const allDbIds = [];

  seatAvg.forEach(seat => {
    const dbId = window.seatIdToDbId[seat.id];
    if (!dbId) return;
    const colorHex = getColor(parseFloat(seat.rate)); // â† getColor() ä½¿ç”¨
    const color = hexToVector4(colorHex); // â† Forgeç”¨ã«å¤‰æ›
    viewer.setThemingColor(dbId, color);
    allDbIds.push(dbId);
  });

  console.log("âœ… Forge ãƒ¢ãƒ‡ãƒ«ã«ç¨¼åƒç‡ã‚«ãƒ©ãƒ¼ã‚’é©ç”¨å®Œäº†");

  // === å¯¾è±¡åº§å¸­ä»¥å¤–ã‚’éè¡¨ç¤º ===
  if (allDbIds.length > 0) {
    viewer.isolate(allDbIds); // ğŸ¯ åº§å¸­ã®ã¿è¡¨ç¤º
    viewer.fitToView(allDbIds); // ğŸ” è‡ªå‹•ã‚ºãƒ¼ãƒ 
    console.log(`ğŸŸ¡ ${allDbIds.length} å€‹ã®åº§å¸­ã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã‚’éè¡¨ç¤º`);
  }
}





// ===================================================
// ğŸš€ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³ã§å‘¼ã°ã‚Œã‚‹å‡¦ç†
async function loadDataAndColorize() {
  console.log("ğŸ”¹ ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹...");
  await loadData();

  // loadData() ã®ä¸­ã§ seatAvg ã‚’ä¿å­˜ã—ã¦ãŠãã“ã¨ï¼
  const seatAvg = window.latestSeatAvg;
  if (!seatAvg) {
    console.warn("âš ï¸ seatAvg æœªå–å¾—ã®ãŸã‚ç€è‰²ã‚¹ã‚­ãƒƒãƒ—");
    return;
  }

  if (geometryReady && window.seatIdToDbId) {
    console.log("ğŸŸ¢ Forge geometryReady â†’ ç€è‰²é–‹å§‹");
    applySeatColors(seatAvg);
  } else {
    console.warn("âš ï¸ Forge ãƒ¢ãƒ‡ãƒ«æœªæº–å‚™ã€‚è‰²ä»˜ã‘ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚");
  }
}

// ===================================================
// ğŸŸ¡ ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã‚¯ãƒªãƒƒã‚¯ â†’ Forgeãƒã‚¤ãƒ©ã‚¤ãƒˆ
document.addEventListener('click', (e) => {
  const row = e.target.closest('#rankingTable tbody tr');
  if (!row) return;
  const seatAttr = row.getAttribute('data-seat');
  const seatId = seatAttr ? parseInt(seatAttr, 10) : NaN;
  if (!isNaN(seatId)) highlightSeat(seatId);
});

// ===================================================
// ğŸ¢ ãƒ•ãƒ­ã‚¢å¤‰æ›´æ™‚ï¼šãƒ‡ãƒ¼ã‚¿æ›´æ–° + ãƒ¢ãƒ‡ãƒ«å´ã®åº§å¸­å†ãƒãƒƒãƒ”ãƒ³ã‚°
document.getElementById('floor').addEventListener('change', async () => {
  await loadData();
  if (geometryReady) {
    await new Promise(r => setTimeout(r, 300));
    identifyGeneralModelDbIds(`${document.getElementById("floor").value}F`);
  }
});

// ===================================================
// ğŸ§© ãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ï¼šãƒ‡ãƒ¼ã‚¿ã¨Viewerã‚’åˆæœŸåŒ–
window.onload = () => {
  loadData();
  initViewer();
};


  </script>
</body>
</html>
