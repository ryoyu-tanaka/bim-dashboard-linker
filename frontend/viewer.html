<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Forge Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
    }
    #viewerContainer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="viewerContainer"></div>

  <script>
    let viewer;
    const floorToDbIdMap = {
      // âœ… éšå±¤ã”ã¨ã®dbIdã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ€ãƒŸãƒ¼ä¾‹ï¼‰
      1: 101, 2: 102, 3: 103, 4: 104, 5: 105,
      6: 106, 7: 107, 8: 108, 9: 109
    };

    // ğŸš€ Forge VieweråˆæœŸåŒ–
    async function initViewer() {
      const options = {
        env: "AutodeskProduction",
        getAccessToken: async (onTokenReady) => {
          const res = await fetch('/api/aps/oauth/token');
          const token = await res.json();
          onTokenReady(token.access_token, token.expires_in);
        }
      };

      Autodesk.Viewing.Initializer(options, () => {
        const htmlDiv = document.getElementById("viewerContainer");
        viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);
        const startedCode = viewer.start();
        if (startedCode > 0) {
          console.error("Viewer failed to start!");
          return;
        }

        // âœ… ã‚µã‚¤ã‚ºå®‰å®šåŒ–ï¼ˆiframeå†…ãƒ¬ãƒ³ãƒ€ãƒ¼åœæ­¢é˜²æ­¢ï¼‰
        window.addEventListener("load", () => viewer.resize());
        window.addEventListener("resize", () => viewer.resize());

        const documentId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6YndtdDFhOWtzeXNwa3AzbHY2MWNsZGxveXUxeHQwenEtYmFzaWMtYXBwLyglRTUlQkElQTclRTUlQjglQUQlRTMlODMlQkIlRTQlQkYlQUUlRTclQjklOTUpJUU4JUI1JUE0JUU1JTlEJTgyWCVFNyVBNCVCRSVFMyU4MyU5MyVFMyU4MyVBQiVFNCVCOCU4RCVFNSU4QiU5NSVFNyU5NCVBMyVFNyVBRSVBMSVFNyU5MCU4NkJJTSVFMyU4MyVBMiVFMyU4MyU4NyVFMyU4MyVBQl8wNTE0LnJ2dA';
        Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
      });
    }

    // âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ
    function onDocumentLoadSuccess(doc) {
      const viewables = doc.getRoot().getDefaultGeometry();
      viewer.loadDocumentNode(doc, viewables).then(() => {
        console.log("Forgeãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† âœ…");

        // GEOMETRY_LOADED_EVENTç™ºç« â†’ ã•ã‚‰ã«1ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰é€šçŸ¥
        viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, async () => {
          console.log("ğŸ§± GEOMETRY_LOADED_EVENT ç™ºç« â†’ 1ç§’å¾…æ©Ÿä¸­...");
          await new Promise(r => setTimeout(r, 1000));

          console.log("âœ… Viewer Ready â†’ è¦ªã«é€šçŸ¥");
          window.parent.postMessage({ type: "VIEWER_READY" }, "*");

          identifyGeneralModelDbIds();
        });
      });
    }

    function onDocumentLoadFailure(err) {
      console.error("Document load failed:", err);
    }

    // ğŸ§  ãƒ¢ãƒ‡ãƒ«å†…åº§å¸­IDæŠ½å‡º
    async function identifyGeneralModelDbIds(targetFloor = "7F") {
      console.log("ğŸŒ³ ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ«ã®DbIdè­˜åˆ¥é–‹å§‹...");
      const model = viewer.model;
      if (!model) return console.warn("âš ï¸ ãƒ¢ãƒ‡ãƒ«æœªãƒ­ãƒ¼ãƒ‰");

      await new Promise(r => setTimeout(r, 1000));

      const instanceTree = model.getData()?.instanceTree;
      if (!instanceTree) return console.warn("âš ï¸ instanceTreeæœªå–å¾—");

      const leafIds = [];
      instanceTree.enumNodeChildren(instanceTree.getRootId(), (id) => {
        if (instanceTree.getChildCount(id) === 0) leafIds.push(id);
      }, true);

      const seatIdToDbId = {};
      model.getBulkProperties(leafIds, ['ã‚¿ã‚¤ãƒ—å', 'éšæ•°', 'Level', 'éš', 'Level Name'], results => {
        results.forEach(r => {
          const typeProp = r.properties.find(p => p.displayName === 'ã‚¿ã‚¤ãƒ—å' && typeof p.displayValue === 'string');
          const floorProp = r.properties.find(p => ['éšæ•°', 'éš', 'Level', 'Level Name'].includes(p.displayName));
          if (!typeProp || !floorProp) return;
          const typeName = typeProp.displayValue;
          const floorName = String(floorProp.displayValue || '');
          if (!/ã‚ªãƒ•ã‚£ã‚¹ãƒã‚§ã‚¢/i.test(typeName)) return;
          if (!floorName.includes(targetFloor)) return;
          const match = typeName.match(/(\d+)$/);
          if (!match) return;
          const seatId = parseInt(match[1]);
          seatIdToDbId[seatId] = r.dbId;
        });
        console.log(`âœ… åº§å¸­DbIdæŠ½å‡ºå®Œäº† (${targetFloor}) ä»¶æ•°: ${Object.keys(seatIdToDbId).length}`);
        window.seatIdToDbId = seatIdToDbId;
      });
    }

    // ğŸ’º åº§å¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    function highlightSeat(seatId) {
      if (!window.seatIdToDbId) return console.warn("âš ï¸ seatIdToDbId æœªå®šç¾©");
      const dbid = window.seatIdToDbId[seatId];
      if (!dbid) return console.warn(`âš ï¸ seat_id:${seatId} ã®dbIdæœªæ¤œå‡º`);
      viewer.clearSelection();
      viewer.isolate([dbid]);
      viewer.fitToView([dbid]);
      viewer.select([dbid]);
      console.log(`ğŸ’¡ Seat ${seatId} â†’ dbId ${dbid} ãƒã‚¤ãƒ©ã‚¤ãƒˆ`);
    }

    // âš¡ éšå±¤ã®è‰²å¡—ã‚Šï¼ˆå®‰å…¨åŒ–ç‰ˆï¼‰
    function applyFloorColors(items) {
      const checkReady = () => {
        if (!viewer || !viewer.impl || !viewer.impl.glrenderer() || !viewer.model) {
          console.warn("âš ï¸ Viewerã¾ã GLæœªåˆæœŸåŒ– â†’ å†è©¦è¡Œ");
          return setTimeout(checkReady, 500);
        }

        console.log("ğŸŸ¢ Viewer GLæº–å‚™å®Œäº† â†’ ç€è‰²é–‹å§‹");

        const min = Math.min(...items.map(i => i.value));
        const max = Math.max(...items.map(i => i.value));

        items.forEach(({ floor, value }) => {
          const intensity = (value - min) / (max - min || 1);
          const color = new THREE.Vector4(1 - intensity, intensity, 0, 1); // ç·‘â†’èµ¤
          const dbId = floorToDbIdMap[floor];
          if (dbId) {
            try {
              viewer.setThemingColor(dbId, color);
            } catch (err) {
              console.warn(`âš ï¸ setThemingColorå¤±æ•— (floor:${floor})`, err);
            }
          }
        });
        viewer.impl.sceneUpdated(true);
        console.log("ğŸ¨ éšå±¤ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚°å®Œäº†");
      };

      checkReady();
    }

    // ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆåº§å¸­ + é›»åŠ› ä¸¡å¯¾å¿œï¼‰
    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (!msg) return;

      // åº§å¸­ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (msg.seat_id) {
        console.log("ğŸ“© seat_idå—ä¿¡:", msg.seat_id);
        highlightSeat(msg.seat_id);
      }

      // é›»åŠ›é‡ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚°
      if (msg.type === "APPLY_FLOOR_COLORS") {
        console.log("ğŸ“© é›»åŠ›é‡ãƒ‡ãƒ¼ã‚¿å—ä¿¡:", msg.items);
        applyFloorColors(msg.items);
      }
    });

    // ğŸš€ Vieweré–‹å§‹
    initViewer();
  </script>
</body>
</html>
