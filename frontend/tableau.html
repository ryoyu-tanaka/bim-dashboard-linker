<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Tableau Dashboard</title>
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; }
    #vizContainer { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="vizContainer"></div>

  <script src="https://public.tableau.com/javascripts/api/tableau-2.min.js"></script>
  <script>
    let viz;

    function initViz() {
      const containerDiv = document.getElementById("vizContainer");
      const url = "https://public.tableau.com/views/111_17620017804110/1?:language=ja-JP&:sid=&:redirect=auth&:display_count=n&:origin=viz_share_link"; // â† ã‚ãªãŸã®URL

      const options = {
        hideToolbar: false,
        onFirstInteractive: () => {
          console.log("âœ… Tableauãƒ­ãƒ¼ãƒ‰å®Œäº†");

          // ğŸ•’ Tableau Publicã¯ãƒ­ãƒ¼ãƒ‰å¾Œã™ãã ã¨ã‚¤ãƒ™ãƒ³ãƒˆãŒåå¿œã—ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ãƒªãƒˆãƒ©ã‚¤
          let retries = 0;
          const interval = setInterval(() => {
            if (viz && retries < 3) {
              console.log("ğŸ” ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²è©¦è¡Œ", retries + 1);
              addClickHandler();
              retries++;
            } else {
              clearInterval(interval);
            }
          }, 2000);
        }
      };

      viz = new tableau.Viz(containerDiv, url, options);
    }

    async function addClickHandler() {
      try {
        const workbook = viz.getWorkbook();
        const activeSheet = workbook.getActiveSheet();
        let worksheets = [];

        if (activeSheet.getSheetType() === "dashboard") {
          worksheets = activeSheet.getWorksheets();
        } else {
          worksheets = [activeSheet];
        }

        console.log("ğŸ§© å†…éƒ¨ã‚·ãƒ¼ãƒˆä¸€è¦§:", worksheets.map(w => w.getName()));

        const eventType = (tableau.TableauEventType && tableau.TableauEventType.MARKS_SELECTION)
          ? tableau.TableauEventType.MARKS_SELECTION
          : "marksselection";

        worksheets.forEach(ws => {
          const name = ws.getName();
          if (name.includes("åº§å¸­") || name.toLowerCase().includes("seat")) {
            console.log("ğŸ¯ ç›£è¦–å¯¾è±¡:", name);

            const addFn = ws.addEventListenerAsync || ws.addEventListener;
            if (typeof addFn === "function") {
              addFn.call(ws, eventType, async (event) => {
                const marks = await event.getMarksAsync();
                marks.forEach(mark => {
                  mark.getPairs().forEach(pair => {
                    if (pair.fieldName.toLowerCase().includes("seat")) {
                      const seatId = pair.formattedValue;
                      console.log("âœ… Tableauã§ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ Seat ID:", seatId);
                      // Forge viewer ã¸é€ä¿¡
                      window.parent.postMessage({ type: "SELECT_SEAT", seatId }, "*");
                    }
                  });
                });
              });
              console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²å®Œäº†: ${name}`);
            } else {
              console.warn(`âš ï¸ ${name} ã¯ addEventListener ã«éå¯¾å¿œ`);
            }
          }
        });

        console.log("âœ… Tableauã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²å®Œäº†");
      } catch (err) {
        console.error("âŒ addClickHandlerå†…ã§ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    initViz();
  </script>
</body>
</html>
