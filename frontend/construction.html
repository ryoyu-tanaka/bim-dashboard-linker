<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Construction Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />

  <style>
    body { font-family:"Inter","Yu Gothic",sans-serif; margin:0; background:#f4f6fa; color:#222; }
    header { background:#1e293b; color:white; padding:16px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.25); }
    header h2 { margin:0; font-size:22px; font-weight:600; letter-spacing:1px; }
    .year-select { display:flex; align-items:center; gap:10px; }
    .year-select label { font-weight:600; font-size:14px; }
    .select-wrapper { position:relative; display:inline-block; }
    select { appearance:none; background-color:white; border:none; border-radius:8px; padding:8px 36px 8px 12px; font-size:14px; font-weight:600; color:#111827; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:all 0.2s ease; }
    select:hover { box-shadow:0 4px 8px rgba(0,0,0,0.2); transform:scale(1.02); }
    .select-wrapper::after { content:"â–¼"; font-size:12px; color:#4b5563; position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; }
    .summary-panel { display:flex; justify-content:space-around; align-items:center; margin:20px; background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:20px; }
    .summary-item { text-align:center; }
    .summary-item h1 { margin:0; color:#2563eb; font-size:34px; }
    .summary-item p { margin:5px 0 0 0; color:#666; }
    .main-layout { display:grid; grid-template-columns:1.4fr 1.2fr 1fr; gap:16px; height:calc(100vh - 220px); margin:20px; }
    .table-box { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow-y:auto; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th,td { padding:6px 10px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f3f4f6; }
    .viewer-panel { position:relative; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); overflow:hidden; display:flex; }
    #forgeViewer { width:100%; height:100%; border-radius:12px; }
    .charts { display:flex; flex-direction:column; gap:16px; }
    .chart-box { background:white; border-radius:12px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); height:50%; }
    .chart-title { text-align:center; font-weight:bold; margin-bottom:6px; }

    /* ğŸ”¹ ã‚«ãƒ©ãƒ¼ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ */
    .legend {
      position:absolute;
      top:16px;
      right:16px;
      background:white;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      padding:10px 14px;
      width:160px;
      font-size:12px;
    }
    .legend-bar {
      height:14px;
      border-radius:4px;
      background:linear-gradient(to right,#2563eb,#10b981,#facc15,#ef4444);
      margin:6px 0;
    }
    .legend-labels {
      display:flex;
      justify-content:space-between;
      color:#555;
    }
    .table-box {
  background: white;
  border-radius: 12px;
  padding: 0;                /* â† paddingã‚’å†…å´ã«ç§»å‹•ï¼ˆpanelå†…ã«ä»˜ã‘ã‚‹ï¼‰ */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;          /* â† ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å­è¦ç´ ãŒæŒã¤ */
  display: flex;
}

.slide-container {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.slide-wrapper {
  display: flex;
  transition: transform 0.4s ease;
  width: 300%; /* â† ã‚¹ãƒ©ã‚¤ãƒ‰æšæ•°ã«å¿œã˜ã¦è¨­å®šï¼ˆ3ãƒ‘ãƒãƒ«ãªã‚‰300%ï¼‰ */
  height: 100%;
}

.slide-panel {
  width: 100%;
  flex-shrink: 0;
  height: 100%;
  overflow-y: auto;          /* â† ã“ã‚Œã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
  padding: 16px 20px;        /* â† ç«¯ã«ä½™ç™½è¿½åŠ  */
  box-sizing: border-box;
  background: #fff;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼èª¿æ•´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
.slide-panel::-webkit-scrollbar {
  width: 8px;
}
.slide-panel::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}


.work-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.work-list li {
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.work-list li:hover { background: #f3f4f6; }

.back-button {
  color: #2563eb;
  cursor: pointer;
  font-weight: 600;
  display: inline-block;
  margin-bottom: 10px;
}

.detail-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin-top: 10px;
}

.detail-table th {
  text-align: left;
  width: 30%;
  padding: 8px 10px;
  background: #f9fafb;
  border-bottom: 1px solid #eee;
  font-weight: 600;
  color: #374151;
  vertical-align: top;
}

.detail-table td {
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
  color: #111827;
  white-space: pre-wrap;
  word-break: break-word;
}



  </style>
</head>

<body>
  <header>
    <h2>å·¥äº‹ãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <div class="year-select">
      <label for="yearSelect">å¹´åº¦ï¼š</label>
      <div class="select-wrapper">
        <select id="yearSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
    </div>
  </header>

  <div class="summary-panel">
    <div class="summary-item">
      <h1 id="totalCost">Â¥0</h1>
      <p>åˆè¨ˆå·¥äº‹é‡‘é¡</p>
    </div>
    <div class="summary-item">
      <h1 id="totalCount">0ä»¶</h1>
      <p>å·¥äº‹ä»¶æ•°</p>
    </div>
  </div>

<div class="main-layout">
  <!-- å·¦ã‚«ãƒ©ãƒ  -->
  <div class="table-box slide-container">
    <div class="slide-wrapper" id="slideWrapper">
      <!-- ğŸ§¾ è²»ç”¨ã®å†…è¨³ -->
      <div class="slide-panel" id="panel-cost">
        <h3>è²»ç”¨ã®å†…è¨³</h3>
        <table id="detailTable">
          <thead>
            <tr><th>å·¥äº‹å</th><th>å·¥ç¨®</th><th>éƒ¨ä½</th><th>é‡‘é¡(å††)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- ğŸ—ï¸ å·¥äº‹ä¸€è¦§ -->
      <div class="slide-panel" id="panel-list">
        <h3 id="floorTitle">å·¥äº‹ä¸€è¦§</h3>
        <ul id="workList" class="work-list"></ul>
      </div>

      <!-- ğŸ“„ å·¥äº‹è©³ç´° -->
      <div class="slide-panel" id="panel-detail">
        <h3 id="detailTitle">å·¥äº‹è©³ç´°</h3>
        <div id="workDetail"></div>
      </div>
    </div>
  </div>

  <!-- ä¸­å¤®ï¼šForge Viewer -->
  <div class="viewer-panel">
    <div id="forgeViewer"></div>
    <div class="legend" id="legendBox" style="display:none;">
      <div><b>éšåˆ¥å·¥äº‹ä»¶æ•°</b></div>
      <div class="legend-bar"></div>
      <div class="legend-labels">
        <span id="minLabel">å°‘</span>
        <span id="maxLabel">å¤š</span>
      </div>
    </div>
  </div>

  <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚°ãƒ©ãƒ• -->
  <div class="charts">
    <div class="chart-box">
      <div class="chart-title">éšåˆ¥å·¥äº‹ä»¶æ•°</div>
      <div id="chartFloorCount" style="width:100%;height:90%;"></div>
    </div>
    <div class="chart-box">
      <div class="chart-title">éƒ¨ä½åˆ¥é‡‘é¡</div>
      <div id="chartPartCost" style="width:100%;height:90%;"></div>
    </div>
  </div>
</div>


    <div class="viewer-panel">
      <div id="forgeViewer"></div>

      <!-- âœ… å‡¡ä¾‹ -->
      <div class="legend" id="legendBox" style="display:none;">
        <div><b>éšåˆ¥å·¥äº‹ä»¶æ•°</b></div>
        <div class="legend-bar"></div>
        <div class="legend-labels">
          <span id="minLabel">å°‘</span>
          <span id="maxLabel">å¤š</span>
        </div>
      </div>
    </div>

    
  </div>

  <!-- âœ… Forge Viewerå³ä¸‹ã«å·¥äº‹ä¸€è¦§ãƒ‘ãƒãƒ« -->
<div id="workListPanel" class="work-list-panel" style="display:none;">
  <h4 id="workListTitle">å·¥äº‹ä¸€è¦§</h4>
</div>

<style>
.work-list-panel {
  position:absolute;
  right:16px;
  bottom:16px;
  width:260px;
  max-height:40%;
  overflow-y:auto;
  background:white;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  padding:10px 12px;
  font-size:13px;
}
.work-list-panel h4 {
  margin:0 0 6px 0;
  font-size:14px;
  font-weight:600;
  color:#111827;
}
.work-list-panel ul { list-style:none; padding:0; margin:0; }
.work-list-panel li {
  padding:6px 8px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.work-list-panel li:hover { background:#f3f4f6; }
</style>


<script>
let allData = [], viewer;
let currentFloor = null;  // ğŸ‘ˆ è¿½åŠ ï¼šä»Šé¸ã°ã‚Œã¦ã„ã‚‹éšï¼ˆä¾‹: 3, 8, 10 ãªã©ï¼‰
const PROP_INDEX = { byDbId:new Map(), byFloor:new Map(), walls:new Set() };
const ROOM_KEYWORDS = [
  "éå¸¸ç”¨EVãƒ›ãƒ¼ãƒ«",
  "ç”·å­ãƒˆã‚¤ãƒ¬",
  "å¥³å­ãƒˆã‚¤ãƒ¬",
  "çµ¦æ¹¯å®¤",
  "å‰å®¤",
  "EVãƒ›ãƒ¼ãƒ«",
  "å»Šä¸‹",
  "æ©Ÿæ¢°å®¤"
];

const apiBase =
  location.hostname === "localhost"
    ? "http://localhost:3001"
    : "http://13.231.123.15:3001";


window.onload = async () => {
  // â˜… localhost ç›´æ›¸ã â†’ apiBase ã«å¤‰æ›´
  const res = await fetch(`${apiBase}/api/work/detail`);
  allData = await res.json();

  const years = [...new Set(allData.map(d => d.year))].sort();
  const sel = document.getElementById("yearSelect");

  years.forEach(y => {
    const o = document.createElement("option");
    o.value = y;
    o.textContent = y + "å¹´";
    sel.appendChild(o);
  });

  sel.addEventListener("change", () => updateDashboard(sel.value));

  await initViewer();
};


// ã‚¹ãƒ©ã‚¤ãƒ‰ä½ç½®: 0=å†…è¨³, 1=ä¸€è¦§, 2=è©³ç´°
let currentSlide = 0;

function slideTo(index) {
  const wrapper = document.getElementById("slideWrapper");
  wrapper.style.transform = `translateX(calc(-${index} * 100%))`;
}


function slideTo(index) {
  const wrapper = document.getElementById("slideWrapper");
  currentSlide = index;
  wrapper.style.transform = `translateX(-${index * 100}%)`;
}


// ---------------- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–° ----------------
function updateDashboard(year){
  if(!year)return;
  const filtered=allData.filter(d=>String(d.year)===String(year));
  const total=filtered.reduce((s,d)=>s+Number(d.cost_ex_tax||0),0);
  document.getElementById("totalCost").textContent="Â¥"+total.toLocaleString();
  document.getElementById("totalCount").textContent=filtered.length+"ä»¶";
  updateDetailTable(filtered);
  drawFloorCount(filtered);
  drawPartCost(filtered);
  applyFloorColorByWorkCount(filtered);
}

function updateDetailTable(data){
  const tb=document.querySelector("#detailTable tbody");
  tb.innerHTML="";
  data.forEach(d=>{
    tb.innerHTML+=`<tr><td>${d.work_name||"-"}</td><td>${d.category||"-"}</td><td>${d.part||"-"}</td><td>${Number(d.cost_ex_tax||0).toLocaleString()}</td></tr>`;
  });
}

function drawFloorCount(data){
  const floors=["B1F","1F","2F","3F","4F","5F","6F","7F","8F","9F","10F","RF"];
  const keys=["b1f","1f","2f","3f","4f","5f","6f","7f","8f","9f","10f","rf"];
  const counts=keys.map(k=>data.filter(d=>Number(d[k])===1).length);
  const chart=echarts.init(document.getElementById("chartFloorCount"));
  chart.setOption({tooltip:{trigger:"axis"},xAxis:{type:"category",data:floors},yAxis:{type:"value"},series:[{type:"bar",data:counts,itemStyle:{color:"#2563eb"}}]});
}

function drawPartCost(data){
  const parts={};
  data.forEach(d=>{const p=d.part||"ä¸æ˜";const v=Number(d.cost_ex_tax||0);parts[p]=(parts[p]||0)+v;});
  const sorted=Object.entries(parts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const chart=echarts.init(document.getElementById("chartPartCost"));
  chart.setOption({tooltip:{trigger:"axis"},yAxis:{type:"category",data:sorted.map(d=>d[0]),inverse:true},xAxis:{type:"value"},series:[{type:"bar",data:sorted.map(d=>d[1]),itemStyle:{color:"#10b981"}}]});
}

// ---------------- Forge åˆæœŸåŒ– ----------------
async function initViewer(){
  const options = {
    env: "AutodeskProduction",
    getAccessToken: async (cb) => {
      const r = await fetch('/api/aps/oauth/token');
      const t = await r.json();
      cb(t.access_token, t.expires_in);
    }
  };

  return new Promise(resolve => {
    Autodesk.Viewing.Initializer(options, () => {
      const c = document.getElementById("forgeViewer");
      viewer = new Autodesk.Viewing.GuiViewer3D(c);
      viewer.start();

      const docId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6YndtdDFhOWtzeXNwa3AzbHY2MWNsZGxveXUxeHQwenEtYmFzaWMtYXBwLyglRTUlQkElQTclRTUlQjglQUQlRTMlODMlQkIlRTQlQkYlQUUlRTclQjklOTUpJUU4JUI1JUE0JUU1JTlEJTgyWCVFNyVBNCVCRSVFMyU4MyU5MyVFMyU4MyVBQiVFNCVCOCU4RCVFNSU4QiU5NSVFNyU5NCVBMyVFNyVBRSVBMSVFNyU5MCU4NkJJTSVFMyU4MyVBMiVFMyU4MyU4NyVFMyU4MyVBQl8wNTE0LnJ2dA'; // â† ã‚ãªãŸã®URN
      Autodesk.Viewing.Document.load(docId, (doc) => {
        const geom = doc.getRoot().getDefaultGeometry();
        viewer.loadDocumentNode(doc, geom).then(() => {
          viewer.fitToView();

          // âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
          viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, async () => {
            await indexModelProperties();
            console.log("ğŸ“š Indexed Floors:", [...PROP_INDEX.byFloor.keys()]);

            // âœ… â† ã“ã“ã«è¿½åŠ ã™ã‚‹
viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, async (ev) => {
  if (!ev.dbIdArray || ev.dbIdArray.length === 0) return;
  const dbId = ev.dbIdArray[0];
  let rec = PROP_INDEX.byDbId.get(dbId);

  // âœ… baseãŒå–ã‚Œã¦ãªã„å ´åˆã€Forgeã‹ã‚‰ç›´æ¥å–å¾—
  if (!rec || !rec.base) {
    const props = await getProps(dbId);
    const base = props.properties.find(p =>
      ["åŸºæº–ãƒ¬ãƒ™ãƒ«", "Base Level", "Level", "å‚ç…§ãƒ¬ãƒ™ãƒ«", "åŸºæº–æ‹˜æŸ"].includes(p.displayName)
    )?.displayValue;
    const cat = props.properties.find(p =>
      ["ã‚«ãƒ†ã‚´ãƒª", "Category"].includes(p.displayName)
    )?.displayValue;
    rec = { ...rec, base, cat };
  }

  if (!rec || !rec.base) {
    console.warn("âš ï¸ éšæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", rec);
    return;
  }

  const floor = parseFloorFromBaseLevel(rec.base);
  if (floor === null) return;

  console.log(`ğŸ¢ é¸æŠã•ã‚ŒãŸè¦ç´  â†’ ${rec.base}ï¼ˆéš: ${floor}ï¼‰`);

  // âœ… å¯¾å¿œã™ã‚‹floorKeyç”Ÿæˆ
  const floorKey = (floor < 0)
    ? `b${Math.abs(floor)}f`
    : (floor === 999 ? "rf" : `${floor}f`);

  // âœ… éšã®å·¥äº‹ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
  const floorWorks = allData.filter(d => Number(d[floorKey]) === 1);

  // âœ… å·¦ãƒ‘ãƒãƒ«æ›´æ–°ï¼ˆæ—¢å­˜æ©Ÿèƒ½ç¶­æŒï¼‰
  updateWorkListPanel(floor, floorWorks);

  // âœ… Forgeãƒ¢ãƒ‡ãƒ«ã§é¸æŠéšã®ã¿è¡¨ç¤º
  const floorNodes = PROP_INDEX.byFloor.get(floor);
  if (floorNodes && floorNodes.size > 0) {
    // âœ… isolateå¯¾è±¡ã‹ã‚‰å¤©äº•ã‚«ãƒ†ã‚´ãƒªé™¤å¤–
const ids = [...floorNodes].filter(id => {
  const rec = PROP_INDEX.byDbId.get(id);
  if (!rec) return false;
  // ã€Œå£ã€ã‚„ã€ŒåºŠã€ãªã©æ®‹ã—ã€ã€Œå¤©äº•ã€ã¯é™¤å¤–
  return rec.cat && !/å¤©äº•|Ceiling/i.test(rec.cat);
});

// éšãƒ¢ãƒ‡ãƒ«ã‚’isolatedè¡¨ç¤ºï¼†ã‚ºãƒ¼ãƒ 
if (ids.length > 0) {
  viewer.isolate(ids);
  viewer.fitToView(ids);
}
  // ğŸŸ¢ è‡ªå‹•ã‚ºãƒ¼ãƒ 
  } else {
    console.warn("âš ï¸ éšãƒãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", floor);
  }
});


            resolve();
          });
        });
      });
    });
  });
}


// ---------------- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£èµ°æŸ» ----------------
function enumAllDbIds(){const it=viewer.model.getData().instanceTree;if(!it)return[];const r=it.getRootId();const all=[];(function w(id){all.push(id);it.enumNodeChildren(id,c=>w(c));})(r);return all;}
function getProps(dbId){return new Promise(res=>viewer.getProperties(dbId,p=>res(p),()=>res(null)));}

async function indexModelProperties(){
  const all=enumAllDbIds();
  const NAME=["åå‰","Name"],CATEGORY=["ã‚«ãƒ†ã‚´ãƒª","Category"],BASELEVEL=["åŸºæº–ãƒ¬ãƒ™ãƒ«"];
  for(const id of all){
    const p=await getProps(id); if(!p) continue;
    const name=p.properties.find(x=>NAME.includes(x.displayName))?.displayValue;
    const cat=p.properties.find(x=>CATEGORY.includes(x.displayName))?.displayValue;
    const base=p.properties.find(x=>BASELEVEL.includes(x.displayName))?.displayValue;
    const floor=parseFloorFromBaseLevel(base);
    const normalizedFloor = (/GL/i.test(base)) ? 1 : floor;
    if(normalizedFloor!==null){
      if(!PROP_INDEX.byFloor.has(normalizedFloor))
        PROP_INDEX.byFloor.set(normalizedFloor,new Set());
      PROP_INDEX.byFloor.get(normalizedFloor).add(id);
    }
    if(cat&&/å£|Wall/i.test(cat))PROP_INDEX.walls.add(id);
    PROP_INDEX.byDbId.set(id,{dbId:id,name,cat,base,floor:normalizedFloor});
  }
}
// ===================================================
// ğŸ¨ ç¨¼åƒç‡â†’è‰²å¤‰æ›é–¢æ•°
// ===================================================

// === ã‚«ãƒ©ãƒ¼åˆ¤å®šé–¢æ•° ===
function getColor(rate) {
  if (rate < 30) return "#3b82f6";     // é’ï¼ˆä½ï¼‰
  if (rate < 60) return "#10b981";     // ç·‘ï¼ˆä¸­ï¼‰
  if (rate < 80) return "#facc15";     // é»„ï¼ˆé«˜ï¼‰
  return "#ef4444";                    // èµ¤ï¼ˆéå¸¸ã«é«˜ï¼‰
}

// === HEXã‚«ãƒ©ãƒ¼ â†’ THREE.Vector4å¤‰æ› ===
function hexToVector4(hex, alpha=0.6) {
  const r = parseInt(hex.slice(1, 3), 16) / 255;
  const g = parseInt(hex.slice(3, 5), 16) / 255;
  const b = parseInt(hex.slice(5, 7), 16) / 255;
  return new THREE.Vector4(r, g, b, alpha);
}

function parseFloorFromBaseLevel(base){
  if(!base) return null;
  if(/^B\d+FL$/i.test(base)) return -parseInt(base.match(/^B(\d+)FL$/i)[1],10);
  if(/^\d+FL$/i.test(base)) return parseInt(base.match(/^(\d+)FL$/i)[1],10);
  if(/R|P|Roof|å±‹ä¸Š/i.test(base)) return 999; // âœ… ã“ã“è¿½åŠ 
  if(/GL/i.test(base)) return 1;
  return null;
}

function applyFloorColorByWorkCount(data){
  if(!viewer || !PROP_INDEX.byFloor.size) return;

  viewer.clearThemingColors();

  // å„éšã®ä»¶æ•°ã‚«ã‚¦ãƒ³ãƒˆ
  const floorKeys = ["b1f","1f","2f","3f","4f","5f","6f","7f","8f","9f","10f","rf"];
  const floorMap = new Map();
  floorKeys.forEach((k,i)=>{
    const count = data.filter(d => Number(d[k]) === 1).length;
    floorMap.set(i===0?-1:i===11?999:i, count);
  });

  const max = Math.max(...floorMap.values());
  const min = Math.min(...floorMap.values().filter(v=>v>0));

  floorMap.forEach((count, floor)=>{
    if(count === 0) return;
    // âœ… ä»¶æ•°â†’å‰²åˆï¼ˆ0ã€œ100ï¼‰
    const rate = ((count - min) / (max - min || 1)) * 100;
    const hexColor = getColor(rate);
    const color = hexToVector4(hexColor, 0.6);

    const floorNodes = PROP_INDEX.byFloor.get(floor);
    if(!floorNodes) return;

    const ids = [...floorNodes].filter(id=>{
      const rec = PROP_INDEX.byDbId.get(id);
      if(!rec) return false;
      if(!/å£|Wall/i.test(rec.cat || "")) return false;
      if(floor === 1 && /GL/i.test(rec.base)) return true;
      if(floor === 999 && /R|Roof|å±‹ä¸Š/i.test(rec.base)) return true;
      return rec.floor === floor;
    });

    ids.forEach(id => viewer.setThemingColor(id, color));
  });

  viewer.isolate([...PROP_INDEX.walls]);
  viewer.fitToView([...PROP_INDEX.walls]);

  // âœ… å‡¡ä¾‹æ›´æ–°
  const legend = document.getElementById("legendBox");
  document.getElementById("minLabel").textContent = min + "ä»¶";
  document.getElementById("maxLabel").textContent = max + "ä»¶";
  legend.style.display = "block";

  console.log("ğŸ¨ Forgeãƒ¢ãƒ‡ãƒ«ç€è‰²å®Œäº†ï¼ˆGLãƒ»Réšå¯¾å¿œï¼‰");
}

// ================================================
// ğŸ§© å…¨ãƒ¢ãƒ‡ãƒ«ã‚’èµ°æŸ» â†’ CategoryãŒã€ŒRevit ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ«ã€ã®è¦ç´ ã‚’å…¨å‡ºåŠ›
// ================================================
async function debugListAllRevitGeneralModels() {
  console.group("ğŸ” Revit ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ« å…¨ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹");

  const allIds = enumAllDbIds();
  let count = 0;

  for (const id of allIds) {
    const props = await getProps(id);
    if (!props || !props.properties) continue;

    const category = props.properties.find(p =>
      ["ã‚«ãƒ†ã‚´ãƒª", "Category"].includes(p.displayName)
    )?.displayValue;

    if (!category || !/Revit\s*ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ«/i.test(category)) continue;

    count++;
    console.group(`ğŸ§± dbId: ${id} | Category: ${category}`);
    props.properties.forEach(p => {
      console.log(`${p.displayName}:`, p.displayValue);
    });
    console.groupEnd();
  }

  console.groupEnd();
  console.log(`âœ… æ¤œå‡ºã•ã‚ŒãŸã€ŒRevit ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ«ã€: ${count} ä»¶`);
}


// ğŸ”¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆéšÃ—ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ä¿æŒï¼‰
const MODEL_CACHE = new Map();

async function highlightRoomsByKeyword(floor, keyword) {
  console.group(`ğŸ” ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆéš: ${floor}, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}ï¼‰`);

  const floorLabel = `${floor}F`;
  const allIds = enumAllDbIds();
  const matchedIds = [];

  for (const id of allIds) {
    const props = await getProps(id);
    if (!props || !props.properties) continue;

    const category = props.properties.find(p =>
      ["ã‚«ãƒ†ã‚´ãƒª", "Category"].includes(p.displayName)
    )?.displayValue;

    if (!category || !/Revit\s*ä¸€èˆ¬ãƒ¢ãƒ‡ãƒ«/i.test(category)) continue;

    const typeName = props.properties.find(p =>
      ["ã‚¿ã‚¤ãƒ—å", "Type Name"].includes(p.displayName)
    )?.displayValue;

    const floorProp = props.properties.find(p =>
      ["éšæ•°"].includes(p.displayName)
    )?.displayValue;

    if (!floorProp || floorProp.toUpperCase() !== floorLabel.toUpperCase()) continue;

    const extractedKeyword =
      typeName && typeName.includes("_") ? typeName.split("_")[1].trim() : null;

    if (extractedKeyword && extractedKeyword.includes(keyword)) {
      matchedIds.push(id);
    }
  }

  if (matchedIds.length === 0) {
    console.warn(`âš ï¸ è©²å½“ãƒ¢ãƒ‡ãƒ«ãªã—ï¼ˆéš: ${floor}, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}ï¼‰`);
    return;
  }

  // âœ… å¯¾è±¡ãƒ¢ãƒ‡ãƒ« isolateï¼‹èµ¤ç€è‰²
  viewer.clearThemingColors();
  viewer.isolate(matchedIds);
  matchedIds.forEach(id =>
    viewer.setThemingColor(id, new THREE.Vector4(1, 0, 0, 0.9))
  );
  viewer.fitToView(matchedIds);

  console.log(`âœ¨ ${matchedIds.length} ä»¶ isolateï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆå®Œäº†`);
  console.groupEnd();
}






function updateWorkListPanel(floor, works) {
  // ğŸ‘‡ ã“ã“ã‚’å¿…ãšè¶³ã™
  currentFloor = floor;

  const list = document.getElementById("workList");
  const title = document.getElementById("floorTitle");
  if (!works.length) return;

  let floorLabel = floor === 999 ? "Réš" : floor === -1 ? "B1éš" : `${floor}éš`;
  title.textContent = `${floorLabel}ã®å·¥äº‹ä¸€è¦§ï¼ˆ${works.length}ä»¶ï¼‰`;

  list.innerHTML = "";

  const backBtn = document.createElement("div");
  backBtn.className = "back-button";
  backBtn.textContent = "â† æˆ»ã‚‹";
  backBtn.onclick = () => {
    // å…¨ä½“ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã“ã“ã¯ floor ä½¿ã‚ãªã„ï¼‰
    viewer.isolate([]);
    applyFloorColorByWorkCount(allData);
    currentFloor = null;   // ğŸ‘ˆ å…¨ä½“ãƒ“ãƒ¥ãƒ¼ãªã®ã§ã‚¯ãƒªã‚¢ã—ã¦ãŠãã¨å®‰å…¨
    slideTo(0);
  };
  list.appendChild(backBtn);

  works.forEach(w => {
    const li = document.createElement("li");
    li.textContent = w.work_name || "(åç§°ä¸æ˜)";
    li.onclick = () => showWorkDetail(w);
    list.appendChild(li);
  });

  slideTo(1);
}



// --------------------------------------------
// âœ… å·¥äº‹è©³ç´°è¡¨ç¤º
// --------------------------------------------
function showWorkDetail(work) {
  const detailDiv = document.getElementById("workDetail");
  const title = document.getElementById("detailTitle");
  title.textContent = work.work_name || "(åç§°ä¸æ˜)";

  // âœ… è¡¨ç¤ºå¯¾è±¡ï¼šéšãƒ•ãƒ©ã‚°ä»¥å¤–ã‚’æŠ½å‡º
  const skipKeys = [
    "b1f", "1f", "2f", "3f", "4f", "5f", "6f", "7f", "8f", "9f", "10f", "rf"
  ];

  const labels = {
    _property_id_: "ä¿®ç¹•å·¥äº‹ID",
    property_name: "ç‰©ä»¶å",
    year: "å¹´åº¦",
    completion_date: "å®Œäº†æ—¥",
    work_name: "å·¥äº‹å",
    category: "å·¥ç¨®",
    part: "éƒ¨ä½",
    detail: "å†…å®¹",
    work_detail: "å·¥äº‹å†…å®¹",
    reason: "å·¥äº‹å®Ÿæ–½ç†ç”±",
    approval_note: "è¦‹ç©æ›¸ãƒ‘ã‚¹",
    contractor: "å·¥äº‹æ¥­è€…",
    responsible_person: "ä¿®ç¹•æ‹…å½“è€…",
    cost_ex_tax: "å·¥äº‹é‡‘é¡ï¼ˆç¨åˆ¥ï¼‰",
    status: "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
  };

  let tableRows = "";

  for (const [key, value] of Object.entries(work)) {
    if (skipKeys.includes(key)) continue;
    const label = labels[key] || key;
    let val = value ?? "-";

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    if (key === "cost_ex_tax" && !isNaN(val))
      val = "Â¥" + Number(val).toLocaleString();

    // æ”¹è¡Œå«ã‚€é•·æ–‡ã¯æ•´å½¢
    if (typeof val === "string" && val.includes("\n"))
      val = val.replace(/\n/g, "<br>");

    tableRows += `
      <tr>
        <th style="white-space:nowrap;">${label}</th>
        <td>${val}</td>
      </tr>
    `;
  }

  detailDiv.innerHTML = `
    <table style="
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      table-layout: fixed;
      word-break: break-word;
    ">
      <tbody>${tableRows}</tbody>
    </table>
    <div class="back-button" onclick="returnToList()">â† ä¸€è¦§ã¸æˆ»ã‚‹</div>
  `;

  // âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è©³ç´°ç”»é¢ã«é·ç§»
  slideTo(2);

  // âœ… ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‡¦ç†ï¼ˆè©³ç´°ã«å…¥ã£ãŸã¨ãã ã‘ï¼‰
  const matchedKeyword = ROOM_KEYWORDS.find(kw =>
    work.work_name && work.work_name.includes(kw)
  );

  if (matchedKeyword) {
    console.log(`ğŸ¯ å·¥äº‹è©³ç´° â†’ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${matchedKeyword}ã€ã§ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹`);
    highlightRoomsByKeyword(currentFloor, matchedKeyword); // ğŸ”´ isolate + èµ¤ç€è‰²
  }
}

// --------------------------------------------
// âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³åˆ¶å¾¡ï¼ˆéšå…¨ä½“ã«æˆ»ã™ï¼‰
// --------------------------------------------
function returnToList() {
  console.log("â†©ï¸ ä¸€è¦§ã¸æˆ»ã‚‹ â†’ éšå…¨ä½“ã‚’å†è¡¨ç¤º");

  // currentFloor ãŒã¡ã‚ƒã‚“ã¨å…¥ã£ã¦ã„ã‚‹ã¨ã
  if (currentFloor != null && PROP_INDEX.byFloor.has(currentFloor)) {
    const ids = [...PROP_INDEX.byFloor.get(currentFloor)];

    viewer.clearThemingColors();
    viewer.isolate(ids);                 // ğŸ‘ˆ ãã®éšã ã‘è¡¨ç¤º
    applyFloorColorByWorkCount(allData); // ğŸ‘ˆ éšåˆ¥ã®è‰²ã‚’æˆ»ã™
  } else {
    // å¿µã®ãŸã‚ã®ä¿é™ºï¼šfloor ãŒåˆ†ã‹ã‚‰ãªã„ã¨ãã¯å…¨ä½“ã«æˆ»ã™
    viewer.isolate([]);
    applyFloorColorByWorkCount(allData);
  }

  // ç”»é¢ã ã‘ä¸€è¦§ã«æˆ»ã™
  slideTo(1);
}


// --------------------------------------------
// âœ… ä¸€è¦§ã‚’é–‰ã˜ã¦å…¨ä½“ã¸æˆ»ã‚‹å ´åˆï¼ˆæœ€ä¸Šä½ï¼‰
// --------------------------------------------
function closeWorkDetail(){
  document.getElementById("workListPanel").innerHTML =
    `<h4 id="workListTitle"></h4><ul id="workList"></ul>`;
  document.getElementById("workListPanel").style.display = "none";

  viewer.isolate([]);                  // å…¨ä½“è¡¨ç¤º
  applyFloorColorByWorkCount(allData); // å…¨ä½“è‰²
  currentFloor = null;                 // ğŸ‘ˆ å…¨ä½“ãªã®ã§ã‚¯ãƒªã‚¢
  slideTo(0);
}



</script>
</body>
</html>
